<div class="room">
    <header>
        <div class="brand">APTITUDE <span>ARENA</span></div>
        <div class="spacer"></div>
        <div class="user">üë§ {{ username }}</div>
        <button class="logout" (click)="onLogout()">BACK TO DASHBOARD</button>
    </header>

    <main>
        <!-- Pre-room screen -->
        <div *ngIf="!generatedCode" class="pre-room">
            <div class="create-panel">
                <h2>Forge Your Challenge!</h2>
                <input type="text" [(ngModel)]="challengeName" placeholder="e.g. Brain Busters Arena" />
                <label>Choose Domain</label>
                <div class="domains">
                    <button [class.active]="domain==='Verbal'" (click)="selectDomain('Verbal')">Verbal Ability</button>
                    <button [class.active]="domain==='Logical'" (click)="selectDomain('Logical')">Logical Reasoning</button>
                    <button [class.active]="domain==='Quant'" (click)="selectDomain('Quant')">Quantitative Aptitude</button>
                    <button [class.active]="domain==='Mixed'" (click)="selectDomain('Mixed')">Mixed</button>
                </div>
                <div class="timer-hint">
                    <p>‚è± {{ currentTimerLabel }} ‚Ä¢ {{ currentTimerSeconds }}s per question</p>
                    <small>Timer auto-submits at zero and stays synced for the entire room.</small>
                </div>
                <div class="timer-legend">
                    <div class="timer-pill" *ngFor="let rule of timerRules">
                        <span class="label">{{ rule.label }}</span>
                        <span class="value">{{ rule.seconds }}s</span>
                    </div>
                </div>
                <label>Number of Questions</label>
                <input type="number" min="1" max="50" [(ngModel)]="numQuestions" />
                <label>Max Players</label>
                <input type="number" [min]="minPlayersRequired" [max]="maxPlayersAllowed" [(ngModel)]="squadSize" />
                <div class="capacity-hint">
                    <p>üî¢ {{ minPlayersRequired }} players needed to start ¬∑ üë• Max {{ maxPlayersAllowed }} per room</p>
                </div>
                <button class="primary" (click)="createRoom()">Create Battleground!</button>
            </div>

            <div class="join-panel">
                <h2>Leap into the Arena!</h2>
                <p>Join with an invite code</p>
                <input type="text" [(ngModel)]="roomCode" placeholder="Invite Code" />
                <button class="success" (click)="joinRoom()">Join Room</button>
                <div class="matchmaking-note">
                    <p>Need at least {{ minPlayersRequired }} players to launch. Hosts can start early for solo practice.</p>
                    <p>Rooms cap at {{ maxPlayersAllowed }} challengers to keep gameplay fair.</p>
                </div>
            </div>
        </div>

        <!-- Lobby / quiz -->
        <div *ngIf="generatedCode" class="lobby">
            <div class="code-box">Invite Code: {{ generatedCode }}
                <button class="logout" (click)="copyCode()">Copy</button>
            </div>

            <header class="settings-bar">
                <div class="challenge-title" *ngIf="settings.challengeName">
                    <h2>üèÜ {{ settings.challengeName }}</h2>
                </div>
                <div class="summary">
                    <div class="summary-item">
                        <span class="label">Players</span>
                        <span class="value">{{ players.length }} / {{ settings.maxPlayers || maxPlayersAllowed }}</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Questions</span>
                        <span class="value">{{ settings.numQuestions }}</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Category</span>
                        <span class="value">{{ settings.domain }}</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Timer</span>
                        <span class="value">{{ currentTimerLabel }} ‚Ä¢ {{ currentTimerSeconds }}s</span>
                    </div>
                </div>
                <div class="owner-controls" *ngIf="isOwner && !quizStarted">
                    <button class="accent" (click)="startQuiz()" [disabled]="players.length === 0">Start Quiz!</button>
                    <small>Need {{ minPlayersRequired }}+ players to auto-launch. You can force start for warmups.</small>
                </div>
            </header>
            <div class="capacity-strip">
                <span>Minimum to start: {{ minPlayersRequired }} players</span>
                <span>Maximum allowed: {{ settings.maxPlayers || maxPlayersAllowed }}</span>
                <span>Timer is server-synced‚Äîauto-submits at zero.</span>
            </div>

            <main class="game-layout">
                <aside class="players">
                    <h3>üèÜ Leaderboard</h3>
                    <ul>
                        <li *ngFor="let p of players; let i = index" [class.rank-1]="i === 0" [class.rank-2]="i === 1" [class.rank-3]="i === 2" [class.current-player]="p.username === username">
                            <span class="rank-icon">{{ getRankIcon(i) }}</span>
                            <span class="player-name">{{ p.username }}</span>
                            <span class="score">{{ p.score || 0 }} pts</span>
                        </li>
                    </ul>
                </aside>

                <section class="whiteboard">
                    <h2 *ngIf="!quizStarted && !showFinalResults">Waiting for host to start...</h2>

                    <!-- Quiz Questions -->
                    <div *ngIf="quizStarted && !showFinalResults" class="qcard">
                        <div class="q-meta">
                            <div>Q {{ currentQuestionIndex + 1 }} / {{ settings.numQuestions }}</div>
                            <div class="timer" [class.warning]="timeLeftSeconds <= 10">
                                <span class="timer-label">{{ currentQuestionTimerLabel || currentTimerLabel }}</span>
                                <span class="timer-value">{{ timeLeftSeconds }}s</span>
                            </div>
                        </div>
                        <p class="timer-note">‚è± No response when the timer expires? We mark ‚ÄúNo Answer‚Äù and advance automatically.</p>
                        <h2 class="q">{{ currentQuestion }}</h2>
                        <div class="opts">
                            <button *ngFor="let opt of currentOptions; let i = index" (click)="chooseOption(opt)" [disabled]="hasAnswered" [class.answered]="hasAnswered" [class.selected]="currentAnswers[username] === i">
                                {{ opt }}
                            </button>
                        </div>
                        <div *ngIf="hasAnswered && waitingForOthers" class="waiting">
                            <p>‚úÖ Answer submitted! Waiting for other players...</p>
                            <div class="answers-status">
                                <div *ngFor="let player of players" class="player-status">
                                    <span class="player-name">{{ player.username }}</span>
                                    <span class="status-icon">{{ currentAnswers[player.username] !== undefined ? '‚úÖ' : '‚è≥' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Final Results -->
                    <div *ngIf="showFinalResults" class="final-results">
                        <div class="results-header">
                            <h1>üéâ Quiz Complete!</h1>
                            <p>Final Rankings</p>
                        </div>
                        <div class="podium-grid">
                            <div *ngFor="let player of topThreePlayers; let i = index" class="rank-card" [class.rank-1]="i === 0" [class.rank-2]="i === 1" [class.rank-3]="i === 2">
                                <div class="rank-badge">{{ getRankIcon(i) }}</div>
                                <div class="player-info">
                                    <h3>{{ getRankText(i) }}</h3>
                                    <p class="player-name">{{ player?.username || '‚Äî' }}</p>
                                    <p class="final-score">{{ player?.score || 0 }} pts</p>
                                </div>
                            </div>
                        </div>
                        <ul class="rest-list" *ngIf="remainingPlayers.length">
                            <li *ngFor="let player of remainingPlayers; let idx = index">
                                <span class="rank-order">{{ idx + 4 }}.</span>
                                <span class="name">{{ player.username }}</span>
                                <span class="score">{{ player.score || 0 }} pts</span>
                            </li>
                        </ul>
                        <div class="results-footer">
                            <p>üèÜ Congratulations to all participants!</p>
                            <button class="play-again" (click)="showFinalResults = false">Play Again</button>
                        </div>
                    </div>
                </section>

                <aside class="chat">
                    <h3>Chat</h3>
                    <div class="messages">
                        <div *ngFor="let msg of chat">{{ msg }}</div>
                    </div>
                    <input [(ngModel)]="newMessage" placeholder="Type your message..." />
                    <button (click)="sendMessage()">Send</button>
                </aside>
            </main>
        </div>
    </main>
</div>